---
title: "Laboratorio: Mi Primera Aplicaci√≥n en Kubernetes"
date: last-modified
author:
  - name: Francisco Palm
    orcid: 0000-0002-1293-0868
    email: fpalm@qu4nt.com
    affiliations: qu4nt
format:
  html:
    toc: true
html-math-method:
  method: mathjax
  url: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
lang: es
logo: images/qu4nt-logo.png
lightbox: true

---

# Laboratorio: Desplegando mi Primera Aplicaci√≥n en Kubernetes

## Objetivos de Aprendizaje

Al finalizar este laboratorio, los participantes podr√°n:

- Instalar y configurar un cl√∫ster local de Kubernetes usando Minikube
- Utilizar `kubectl` para interactuar con el cl√∫ster
- Crear y gestionar Deployments y Pods
- Escalar aplicaciones y entender la autorecuperaci√≥n de Kubernetes
- Solucionar problemas comunes en un entorno local de Kubernetes

## Prerrequisitos

- Conocimientos b√°sicos de l√≠nea de comandos
- Acceso a una m√°quina con Windows, macOS o Linux
- M√≠nimo 8GB de RAM y 20GB de espacio libre en disco
- Conexi√≥n a Internet para descargar componentes

---

## Parte 1: Instalaci√≥n de Minikube

### Verificaci√≥n de Virtualizaci√≥n

**Linux:**
```bash
grep -E --color 'vmx|svm' /proc/cpuinfo
```

**Windows (PowerShell como Administrador):**
```powershell
systeminfo | Select-String "Virtualizaci√≥n"
```

**macOS:**
```bash
sysctl -a | grep machdep.cpu.features
```

### Instalaci√≥n de VirtualBox (Linux/Windows)

1. Descargar VirtualBox desde [virtualbox.org](https://www.virtualbox.org/wiki/Downloads)
2. Instalar siguiendo el asistente del instalador
3. Verificar la instalaci√≥n: `VBoxManage --version`

### Instalaci√≥n de Minikube

**Linux:**
```bash
curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64
```

**macOS (Intel):**
```bash
curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-darwin-amd64
sudo install minikube-darwin-amd64 /usr/local/bin/minikube
```

**macOS (ARM - M1/M2/M3):**
```bash
curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-darwin-arm64
sudo install minikube-darwin-arm64 /usr/local/bin/minikube
```

**Windows:**

- Descargar `minikube-installer.exe` desde GitHub Releases
- Ejecutar el instalador (se agregar√° autom√°ticamente al PATH)

### Iniciar el Cl√∫ster Minikube

```bash
# Para VirtualBox (Linux/Windows/Intel Mac)
minikube start --driver=virtualbox

# Para Docker (macOS ARM)
minikube start --driver=docker
```

### Verificar la Instalaci√≥n

```bash
minikube status
minikube version
```

**üí° Desaf√≠o 1:** ¬øQu√© sucede si ejecutas `minikube start` sin especificar un driver? Explica por qu√© Minikube selecciona un driver autom√°ticamente.

---

## Parte 2: Explorando el Cl√∫ster con kubectl

### Instalaci√≥n de kubectl

Minikube incluye una versi√≥n integrada de kubectl, pero podemos instalarlo por separado:

**Linux:**
```bash
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

**macOS:**
```bash
$ curl -LO "htt‚Äåps://dl.k8s.io/release/$(curl -L -s \
https://dl.k8s.io/release/stab...)/bin/darwin/amd64/kubectl"
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
$ sudo chown root: /usr/local/bin/kubectl
```
**windows:**

Descargar kubectl.exe desde [kubernetes.io](https://kubernetes.io/releases/download/#binaries)

La versi√≥n m√°s reciente la puedes encontrar en https://dl.k8s.io/release/stable.txt.

https://dl.k8s.io/v1.34.1/bin/windows/amd64/kubectl.exe

**Verificar la configuraci√≥n:**
```powershell
kubectl version --client
kubectl cluster-info
kubectl get nodes
kubectl get pods -A
```

### Comandos B√°sicos de Exploraci√≥n

```bash
# Ver todos los recursos del cl√∫ster
kubectl get all --all-namespaces

# Ver informaci√≥n detallada del nodo
kubectl describe node minikube

# Ver los servicios del sistema
kubectl get services -n kube-system
```

**üîç Ejercicio de Troubleshooting:** Si `kubectl get nodes` muestra "No resources found", ¬øcu√°les podr√≠an ser las causas y soluciones?

---

## Parte 3: Creando un Deployment con una Aplicaci√≥n Python

### Aplicaci√≥n de Ejemplo: Contador de Visitas

Crearemos un archivo `app.py` para nuestra aplicaci√≥n:

```python
from flask import Flask
import redis
import os
import socket

app = Flask(__name__)
redis_host = os.environ.get('REDIS_HOST', 'localhost')
redis_client = redis.Redis(host=redis_host, port=6379, decode_responses=True)

@app.route('/')
def hello():
    count = redis_client.incr('hits')
    hostname = socket.gethostname()
    return f'''
    <html>
        <body>
            <h1>¬°Hola desde Kubernetes!</h1>
            <p>Visita n√∫mero: <strong>{count}</strong></p>
            <p>Servido por: <strong>{hostname}</strong></p>
            <p>Redis Host: <strong>{redis_host}</strong></p>
        </body>
    </html>
    '''

@app.route('/health')
def health():
    return {'status': 'healthy'}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### Crear el Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY app.py .

EXPOSE 5000

CMD ["python", "app.py"]
```

### requirements.txt
```
Flask==2.3.3
redis==4.6.0
```

### Construir y Publicar la Imagen

```bash
# Evaluar el entorno Docker de Minikube
eval $(minikube docker-env)

# Construir la imagen
docker build -t python-counter-app:v1 .

# Verificar la imagen
docker images | grep python-counter-app
```

### Crear el Deployment

Crear archivo `deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: python-counter
  labels:
    app: python-counter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: python-counter
  template:
    metadata:
      labels:
        app: python-counter
    spec:
      containers:
      - name: python-counter
        image: python-counter-app:v1
        ports:
        - containerPort: 5000
        env:
        - name: REDIS_HOST
          value: "localhost"
---
apiVersion: v1
kind: Service
metadata:
  name: python-counter-service
spec:
  selector:
    app: python-counter
  ports:
  - port: 80
    targetPort: 5000
  type: LoadBalancer
```

### Aplicar el Deployment

```bash
kubectl apply -f deployment.yaml

# Verificar el deployment
kubectl get deployments
kubectl get pods
kubectl get services
```

**üöÄ Desaf√≠o 2:** ¬øPor qu√© el servicio no tiene una IP externa inmediatamente? ¬øC√≥mo podemos acceder a nuestra aplicaci√≥n?

---

## Parte 4: Escalando el Deployment

### Escalar a M√∫ltiples R√©plicas

```bash
# Escalar a 3 r√©plicas
kubectl scale deployment python-counter --replicas=3

# Verificar los pods
kubectl get pods -o wide

# Ver detalles del deployment
kubectl describe deployment python-counter
```

### Verificar la Distribuci√≥n de Carga

```bash
# Acceder a la aplicaci√≥n
minikube service python-counter-service

# Ver logs de m√∫ltiples pods
kubectl logs -l app=python-counter --tail=10
```

**üîç Ejercicio de Troubleshooting:** Si una de las r√©plicas falla al iniciar, ¬øqu√© comandos usar√≠as para diagnosticar el problema?

---

## Parte 5: Simulando Fallas y Autorecuperaci√≥n

### Eliminar un Pod Manualmente

```bash
# Listar pods
kubectl get pods

# Elegir un pod para eliminar
POD_NAME=$(kubectl get pods -l app=python-counter -o jsonpath='{.items[0].metadata.name}')
echo "Eliminando pod: $POD_NAME"

# Eliminar el pod
kubectl delete pod $POD_NAME

# Observar la recreaci√≥n autom√°tica
kubectl get pods -w
```

### Verificar la Recuperaci√≥n Autom√°tica

```bash
# Ver eventos del cluster
kubectl get events --sort-by='.lastTimestamp'

# Verificar que todas las r√©plicas est√©n running
kubectl get pods -l app=python-counter
```

### Probar la Resiliencia de la Aplicaci√≥n

```bash
# Acceder al servicio m√∫ltiples veces
minikube service python-counter-service --url

# Usar curl para hacer requests m√∫ltiples
SERVICE_URL=$(minikube service python-counter-service --url)
for i in {1..10}; do
    curl -s $SERVICE_URL | grep "Visita n√∫mero"
    sleep 1
done
```

**üí° Desaf√≠o 3:** ¬øC√≥mo se mantiene el contador de visitas si los pods se reinician? ¬øQu√© problema identificas y c√≥mo lo resolver√≠as?

---

## Parte 6: Soluci√≥n al Problema de Persistencia

### Implementar Redis para Persistencia

Crear `redis-deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
---
apiVersion: v1
kind: Service
metadata:
  name: redis-service
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
```

### Actualizar el Deployment de la Aplicaci√≥n

Modificar `deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: python-counter
spec:
  replicas: 3
  selector:
    matchLabels:
      app: python-counter
  template:
    metadata:
      labels:
        app: python-counter
    spec:
      containers:
      - name: python-counter
        image: python-counter-app:v1
        ports:
        - containerPort: 5000
        env:
        - name: REDIS_HOST
          value: "redis-service"  # Usar el nombre del servicio
```

### Aplicar los Cambios

```bash
# Desplegar Redis
kubectl apply -f redis-deployment.yaml

# Actualizar la aplicaci√≥n
kubectl apply -f deployment.yaml

# Verificar la conectividad
kubectl get pods
kubectl logs -l app=python-counter | grep "Redis"
```

---

## Parte 7: Perfiles Avanzados de Minikube

### Crear un Perfil Personalizado

```bash
# Crear cluster con perfil personalizado
minikube start --driver=virtualbox --nodes=2 --cpus=2 --memory=4g --disk-size=20g --profile=mi-cluster

# Listar perfiles
minikube profile list

# Cambiar entre perfiles
minikube profile mi-cluster
minikube profile minikube
```

### Desplegar en el Nuevo Perfil

```bash
# Usar el perfil personalizado
minikube profile mi-cluster

# Desplegar nuestra aplicaci√≥n
kubectl apply -f redis-deployment.yaml
kubectl apply -f deployment.yaml

# Verificar en ambos nodos
kubectl get pods -o wide
```

---

## Autoevaluaci√≥n

### Preguntas de Reflexi√≥n

1. ¬øQu√© ventajas ofrece Minikube sobre otras soluciones de Kubernetes local?
2. ¬øC√≥mo maneja Kubernetes la alta disponibilidad de aplicaciones?
3. ¬øQu√© diferencia hay entre un Deployment y un Pod?
4. ¬øPor qu√© es importante usar servicios en lugar de conectar directamente a los pods?
5. ¬øC√≥mo afecta el driver selection al performance de Minikube?

### Validaci√≥n de Conocimientos

**Ejercicio 1:** Crea un nuevo deployment con una aplicaci√≥n simple que muestre "Hola Mundo" y esc√°lelo a 5 r√©plicas.

**Ejercicio 2:** Simula un fallo del nodo principal y observa c√≥mo Kubernetes responde.

**Ejercicio 3:** Configura un perfil de Minikube con containerd como runtime en lugar de Docker.

### Script de Validaci√≥n Autom√°tica

```bash
#!/bin/bash
echo "=== Validaci√≥n del Laboratorio ==="

# Verificar cluster
echo "1. Verificando cluster..."
minikube status > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úì Cluster Minikube funcionando"
else
    echo "‚úó Error: Cluster no disponible"
fi

# Verificar deployments
echo "2. Verificando deployments..."
kubectl get deployment python-counter > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úì Deployment python-counter existe"
    REPLICAS=$(kubectl get deployment python-counter -o jsonpath='{.status.readyReplicas}')
    echo "‚úì R√©plicas activas: $REPLICAS"
else
    echo "‚úó Deployment no encontrado"
fi

# Verificar servicios
echo "3. Verificando servicios..."
kubectl get service python-counter-service > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "‚úì Servicio python-counter-service existe"
else
    echo "‚úó Servicio no encontrado"
fi

# Test de conectividad
echo "4. Test de conectividad..."
SERVICE_URL=$(minikube service python-counter-service --url 2>/dev/null)
if curl -s $SERVICE_URL > /dev/null; then
    echo "‚úì Aplicaci√≥n accesible"
else
    echo "‚úó Error de conectividad"
fi

echo "=== Validaci√≥n completada ==="
```

---

## Limpieza

```bash
# Eliminar recursos espec√≠ficos
kubectl delete -f deployment.yaml
kubectl delete -f redis-deployment.yaml

# O eliminar todo en el namespace
kubectl delete all --all

# Parar Minikube
minikube stop

# Eliminar completamente (opcional)
minikube delete
```

## Recursos Adicionales

- [Documentaci√≥n Oficial de Minikube](https://minikube.sigs.k8s.io/docs/)
- [Kubernetes Documentation](https://kubernetes.io/docs/home/)
- [Kubectl Cheat Sheet](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)

---

**üéâ ¬°Felicidades! Has completado el laboratorio de introducci√≥n a Kubernetes con Minikube.**